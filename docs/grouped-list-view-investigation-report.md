# Notion グループ化リストビュー問題 調査レポート

## 概要
2025年1月18日、Notionデータベースのグループ化されたリストビューが表示されない問題について調査を実施。18:08に一時的に表示成功したが、18:40に再び表示されなくなった現象を分析。

## 判明した技術的事実

### 1. ブロックIDの不一致
**FAQマスター データベース**
- 誤ったブロックID: `212b802c-b0c6-80ea-b7ed-ef4459f38819`
- 正しいブロックID: `215b802c-b0c6-804a-8858-d72d4df6f128`
- Collection ID: `212b802c-b0c6-8014-9263-000b71bd252e`
- グループ化プロパティ: カテゴリ (ID: `oa:|`)

**カフェキネシコンテンツ データベース**
- ブロックID: `212b802c-b0c6-8019-948d-fb893e963bc2`
- Collection ID: `212b802c-b0c6-8010-99dc-e60b60c23605`
- グループ化プロパティ: Status

### 2. Notion API制限問題
- **エラー**: 429 Too Many Requests
- **原因**: ビルド時の過剰なAPI呼び出し
- **影響**: 
  - ビルドの失敗
  - 504 GATEWAY_TIMEOUT
  - デプロイメントの無限キュー状態
- **新APIキー**: `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`

### 3. キャッシュアーキテクチャの複雑性
```
クライアント → CDN → Redis → Memory LRU → Notion API
```
- 各層での有効期限の不一致
- キャッシュ無効化の困難性
- デバッグの複雑化

### 4. react-notion-xライブラリの制限
- `CollectionViewBlock`コンポーネントがグループ化ビューを正しくレンダリングしない
- `collection_query`データの処理が不完全
- カスタム実装が必要

## 18時頃の一時的成功の原因分析

### 成功要因（推測）

#### 1. 完璧なキャッシュ状態
- **18:08時点**: すべてのキャッシュ層が偶然同期
- Notion APIからの最新データが全層に反映
- `collection_query`の完全なデータ取得に成功

#### 2. コード状態
- `/lib/notion.ts`の`generateGroupedHTML`関数が有効
- サーバーサイドでのHTML生成が正常動作
- DOM注入スクリプトが正しく実行

#### 3. API制限前の状態
- レート制限に達していない
- 完全なcollection_viewデータの取得
- すべてのグループ情報が含まれたレスポンス

### 失敗要因（18:40）

#### 1. キャッシュの劣化
```javascript
// 推測されるキャッシュ状態の変化
18:08 - 新鮮なデータ（グループ化情報含む）
18:40 - 古いキャッシュデータ（グループ化情報なし）
```

#### 2. コード変更の副作用
- TypeScriptエラー修正時の意図しない機能無効化
- NextRouterエラー対応によるSSR→SSGの切り替え
- グループ化ロジックの実行パスの変更

#### 3. Notion APIレスポンスの劣化
- 部分的なデータのみ返却
- `view_ids`や`collection_query`の欠落
- レート制限による不完全なレスポンス

## 根本原因

### 1. アーキテクチャの過度な複雑性
- 多層キャッシュによる状態管理の困難
- SSR/SSG/CSRの混在
- 外部ライブラリへの過度な依存

### 2. Notion API統合の脆弱性
- ビルド時の大量API呼び出し
- 適切なレート制限実装の欠如
- エラーハンドリングの不足

### 3. react-notion-xの限界
- グループ化ビューの公式サポートなし
- 回避策の脆弱性
- メンテナンスの困難性

## 技術的詳細

### 実装されたアプローチ
1. **サーバーサイドHTML生成** (`/lib/server-side-group-renderer.ts`)
2. **クライアントサイドDOM操作** (`/public/force-group-rendering.js`)
3. **ハイブリッドAPI実装** (`/lib/hybrid-collection-handler.ts`)
4. **レート制限実装** (`/lib/notion-api-with-retry.ts`)

### 設定値の変遷
```javascript
// 初期設定
MAX_REQUESTS_PER_SECOND: 3
MAX_REQUESTS_PER_MINUTE: 50

// 制限後
MAX_REQUESTS_PER_SECOND: 0.5
MAX_REQUESTS_PER_MINUTE: 10
```

## 推奨される解決策

### 短期的対策
1. **最小限のAPI呼び出し**
   - ビルド時はルートページのみ
   - その他はISR（増分静的再生成）で対応

2. **シンプルなキャッシュ戦略**
   - Redisのみ使用
   - 明確なTTL設定

### 長期的対策
1. **カスタムNotion統合**
   - react-notion-xを使わない独自実装
   - Notion APIの直接利用

2. **アーキテクチャの簡素化**
   - SSRに統一
   - キャッシュ層の削減

3. **監視とアラート**
   - API使用量の監視
   - エラー率の追跡

## 結論
問題の根本原因は、複雑なキャッシュシステムと外部ライブラリの制限、そしてNotion APIのレート制限の組み合わせ。18時頃の成功は、これらすべての要素が偶然整合した結果と推測される。持続可能な解決には、アーキテクチャの簡素化とカスタム実装が必要。